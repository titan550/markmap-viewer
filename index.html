<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paste → Markmap</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/style.css">

  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    #mindmap { width: 100vw; height: 100vh; display: block; }

    .overlay {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      padding: 16px;
      background: rgba(0,0,0,.05);
      transition: opacity .15s ease;
      z-index: 10;
    }
    .card {
      width: min(680px, 100%);
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 12px;
      padding: 18px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
    }
    @media (prefers-color-scheme: dark) {
      .overlay { background: rgba(0,0,0,.35); }
      .card { background: rgba(24,24,27,.92); }
    }
    h1 { margin: 0 0 10px; font-size: 18px; font-weight: 650; }
    p { margin: 0 0 10px; font-size: 13px; opacity: .8; line-height: 1.4; }
    textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,.35);
      padding: 10px 11px;
      font: 12.5px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: transparent;
      color: inherit;
      outline: none;
    }
    textarea:focus { border-color: rgba(74,158,255,.9); }

    .hidden { opacity: 0; pointer-events: none; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-top: 10px; }
    .hint { font-size: 12px; opacity: .7; }
    button {
      appearance: none;
      border: 1px solid rgba(127,127,127,.35);
      background: transparent;
      color: inherit;
      padding: 7px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12.5px;
    }
    button:hover { background: rgba(127,127,127,.08); }
  </style>
</head>

<body>
  <div id="overlay" class="overlay">
    <div class="card">
      <h1>Paste Markdown → Mindmap</h1>
      <p>Paste into the box (or paste anywhere). Renders live. First render hides this panel.</p>
      <textarea id="paste" placeholder="# Title
## Topic
- item
- item"></textarea>
      <div class="row">
        <div class="hint">Tip: start with a single top-level “# …” heading.</div>
        <button id="example" type="button">Example</button>
      </div>
    </div>
  </div>

  <svg id="mindmap"></svg>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.18.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.12/dist/browser/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.12/dist/index.js"></script>

  <script>
    (() => {
      const $ = (s) => document.querySelector(s);

      const svgEl = $("#mindmap");
      const overlayEl = $("#overlay");
      const pasteEl = $("#paste");
      const exampleBtn = $("#example");

      const mmapi = window.markmap;
      if (!mmapi?.Transformer || !mmapi?.Markmap) {
        alert("Markmap failed to load (check DevTools → Network).");
        return;
      }

      const { Transformer, Markmap, Toolbar } = mmapi;

      const transformer = new Transformer();
      const mm = Markmap.create(svgEl);

      const toolbar = new Toolbar();
      toolbar.attach(mm);
      const toolbarEl = toolbar.render();
      toolbarEl.style.position = "absolute";
      toolbarEl.style.right = "16px";
      toolbarEl.style.bottom = "16px";
      document.body.appendChild(toolbarEl);

      let renderedOnce = false;
      let pending = 0;

      function hideOverlayOnce() {
        if (!renderedOnce) {
          overlayEl.classList.add("hidden");
          renderedOnce = true;
        }
      }

      async function render(md) {
        const text = (md || "").trim();
        if (!text) return;

        const token = ++pending;
        try {
          const { root } = transformer.transform(text);
          await mm.setData(root);
          if (token !== pending) return; // drop stale renders
          mm.fit();
          hideOverlayOnce();
        } catch (e) {
          console.error(e);
          alert("Render error: " + (e?.message || String(e)));
        }
      }

      // Debounced typing
      let t = null;
      pasteEl.addEventListener("input", () => {
        clearTimeout(t);
        t = setTimeout(() => render(pasteEl.value), 40);
      });

      // Paste anywhere (desktop). If target is textarea, let it happen naturally.
      document.addEventListener("paste", (ev) => {
        if (ev.target === pasteEl) return;
        const md = ev.clipboardData?.getData("text/plain") || "";
        if (!md.trim()) return;
        ev.preventDefault();
        pasteEl.value = md;
        render(md);
      });

      // Example
      exampleBtn.addEventListener("click", () => {
        const md = [
          "# Paste → Markmap",
          "## Inputs",
          "- paste anywhere",
          "- or type in the box",
          "## Actions",
          "- auto-render",
          "- auto-fit",
          "## Notes",
          "- headings + lists work best",
        ].join("\n");
        pasteEl.value = md;
        render(md);
      });

      // Optional: focus input on load
      window.addEventListener("load", () => pasteEl.focus());
    })();
  </script>
</body>
</html>